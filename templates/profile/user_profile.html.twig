{% extends 'base.html.twig' %}

{% block title %}Profil de {{ user.username }} - {{ parent() }}{% endblock %}

{% block body %}
<div class="container my-5">
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <!-- Header avec avatar et username -->
            <div class="profile-header mb-4">
                <div class="profile-avatar-wrapper">
                    <div class="profile-avatar">
                        <i class="fas fa-user-ninja"></i>
                    </div>
                    <div class="profile-level-badge">
                        <i class="fas fa-star"></i> Lvl {{ user.gameCollections|length + user.consoleCollections|length + user.accessoryCollections|length }}
                    </div>
                </div>
                <div class="profile-header-info">
                    <h1 class="retro-title mb-2">
                        <i class="fas fa-gamepad me-2"></i>{{ user.username }}
                    </h1>
                    {% if user.firstName or user.lastName %}
                    <p class="profile-fullname">
                        {{ user.firstName }} {{ user.lastName }}
                    </p>
                    {% endif %}
                    {% if user.associationJoinDate %}
                    <p class="profile-meta">
                        <i class="fas fa-calendar-plus me-2"></i>Membre depuis le {{ user.associationJoinDate|date('d/m/Y') }}
                    </p>
                    {% endif %}
                </div>
            </div>

            <!-- Statistiques rapides -->
            <div class="row mb-4">
                <div class="col-md-4 mb-3">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-gamepad"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value">{{ user.gameCollections|length }}</div>
                            <div class="stat-label">Jeux</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-desktop"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value">{{ user.consoleCollections|length }}</div>
                            <div class="stat-label">Consoles</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-puzzle-piece"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value">{{ user.accessoryCollections|length }}</div>
                            <div class="stat-label">Accessoires</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Informations personnelles -->
            <div class="profile-section mb-4">
                <div class="profile-section-header">
                    <h3><i class="fas fa-id-card me-2"></i>Informations</h3>
                </div>
                <div class="profile-section-body">
                    <div class="row">
                        {% if is_granted('ROLE_ADMIN') %}
                        <div class="col-md-6 mb-3">
                            <div class="profile-info-item">
                                <span class="profile-info-label">
                                    <i class="fas fa-envelope me-2"></i>Email
                                </span>
                                <span class="profile-info-value">{{ user.email }}</span>
                            </div>
                        </div>
                        {% endif %}
                        {% if user.birthDate %}
                        <div class="col-md-6 mb-3">
                            <div class="profile-info-item">
                                <span class="profile-info-label">
                                    <i class="fas fa-birthday-cake me-2"></i>Date de naissance
                                </span>
                                <span class="profile-info-value">{{ user.birthDate|date('d/m/Y') }}</span>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    {% if user.bio %}
                    <div class="profile-bio mt-3">
                        <h5 class="mb-2"><i class="fas fa-quote-left me-2"></i>Bio</h5>
                        <p class="bio-text">{{ user.bio }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Badges -->
            {% if user.badges|length > 0 %}
            <div class="profile-section mb-4">
                <div class="profile-section-header">
                    <h3><i class="fas fa-trophy me-2"></i>Badges ({{ user.badges|length }})</h3>
                </div>
                <div class="profile-section-body">
                    <div class="badges-grid">
                        {% for badge in user.badges %}
                        <div class="badge-item {% if is_granted('ROLE_ADMIN') %}badge-item-admin{% endif %}" {% if badge.description %}title="{{ badge.description }}"{% endif %}>
                            <div class="badge-image-wrapper">
                                <img src="{{ badge.imageUrl }}" alt="{{ badge.name }}" class="badge-image">
                            </div>
                            <p class="badge-name">{{ badge.name }}</p>
                            {% if badge.description %}
                            <p class="badge-description-hint"><i class="fas fa-info-circle"></i></p>
                            {% endif %}
                            {% if is_granted('ROLE_ADMIN') %}
                            <form method="post" action="{{ path('app_user_badge_remove', {'id': user.id, 'badgeId': badge.id}) }}" class="badge-remove-form">
                                <input type="hidden" name="_token" value="{{ csrf_token('remove_badge_' ~ user.id) }}">
                                <button type="submit" class="btn btn-sm btn-danger badge-remove-btn" onclick="return confirm('Retirer ce badge ?')" title="Retirer ce badge">
                                    <i class="fas fa-times"></i>
                                </button>
                            </form>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% else %}
            <div class="profile-section mb-4">
                <div class="profile-section-header">
                    <h3><i class="fas fa-trophy me-2"></i>Badges</h3>
                </div>
                <div class="profile-section-body text-center py-4">
                    <i class="fas fa-medal fa-3x mb-3 text-muted"></i>
                    <p class="text-muted">Aucun badge pour le moment.</p>
                </div>
            </div>
            {% endif %}

            <!-- Attribution de badges (Admin uniquement) -->
            {% if is_granted('ROLE_ADMIN') and allBadges %}
            <div class="profile-section mb-4 admin-section">
                <div class="profile-section-header bg-warning text-dark">
                    <h3><i class="fas fa-shield-alt me-2"></i>Administration - Attribuer des badges</h3>
                </div>
                <div class="profile-section-body">
                    {% set availableBadges = [] %}
                    {% for badge in allBadges %}
                        {% if badge not in user.badges %}
                            {% set availableBadges = availableBadges|merge([badge]) %}
                        {% endif %}
                    {% endfor %}

                    {% if availableBadges|length > 0 %}
                    <div class="badges-grid">
                        {% for badge in availableBadges %}
                        <div class="badge-item badge-item-available">
                            <div class="badge-image-wrapper">
                                <img src="{{ badge.imageUrl }}" alt="{{ badge.name }}" class="badge-image">
                            </div>
                            <p class="badge-name">{{ badge.name }}</p>
                            <form method="post" action="{{ path('app_user_badge_add', {'id': user.id, 'badgeId': badge.id}) }}">
                                <input type="hidden" name="_token" value="{{ csrf_token('add_badge_' ~ user.id) }}">
                                <button type="submit" class="btn btn-sm btn-success w-100">
                                    <i class="fas fa-plus me-1"></i>Attribuer
                                </button>
                            </form>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-check-circle me-2"></i>
                        Tous les badges ont été attribués à cet utilisateur.
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Boutons d'action -->
            <div class="profile-actions">
                <a href="{{ path('app_collection_user', {'id': user.id}) }}" class="btn btn-primary btn-lg">
                    <i class="fas fa-box-open me-2"></i>Voir la collection
                </a>
                <a href="{{ path('app_collection_users') }}" class="btn btn-secondary btn-lg">
                    <i class="fas fa-users me-2"></i>Tous les membres
                </a>
                {% if is_granted('ROLE_ADMIN') %}
                <a href="{{ path('app_badge_index') }}" class="btn btn-warning btn-lg">
                    <i class="fas fa-cog me-2"></i>Gérer les badges
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
/* Réutilisation des styles de show.html.twig avec quelques ajustements */
.profile-header {
    display: flex;
    align-items: center;
    gap: 2rem;
    padding: 2rem;
    background: linear-gradient(135deg, var(--retro-purple) 0%, var(--retro-red) 100%);
    border-radius: 15px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
    position: relative;
    overflow: hidden;
}

.profile-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: repeating-linear-gradient(0deg, rgba(255, 255, 255, 0.03) 0px, rgba(255, 255, 255, 0.03) 1px, transparent 1px, transparent 2px);
    pointer-events: none;
}

.profile-avatar-wrapper { position: relative; flex-shrink: 0; }
.profile-avatar {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    background: var(--retro-cyan);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3rem;
    color: var(--retro-dark);
    border: 4px solid var(--retro-light);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
}

.profile-level-badge {
    position: absolute;
    bottom: -5px;
    right: -5px;
    background: var(--retro-red);
    color: var(--retro-light);
    padding: 0.3rem 0.8rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: bold;
    border: 2px solid var(--retro-light);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

.profile-header-info { flex: 1; color: var(--retro-light); }
.profile-header-info .retro-title { color: var(--retro-light); margin-bottom: 0.5rem; }
.profile-fullname { font-size: 1.2rem; margin-bottom: 0.3rem; opacity: 0.9; }
.profile-meta { font-size: 0.95rem; opacity: 0.8; margin-bottom: 0; }

.stat-card {
    background: var(--retro-dark);
    border: 2px solid var(--retro-purple);
    border-radius: 10px;
    padding: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    transition: all 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
    border-color: var(--retro-cyan);
    box-shadow: 0 8px 20px rgba(103, 97, 168, 0.3);
}

.stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 10px;
    background: linear-gradient(135deg, var(--retro-purple), var(--retro-cyan));
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.8rem;
    color: var(--retro-light);
}

.stat-info { flex: 1; }
.stat-value { font-size: 2rem; font-weight: bold; color: var(--retro-cyan); line-height: 1; }
.stat-label { color: var(--retro-light); opacity: 0.8; font-size: 0.9rem; margin-top: 0.3rem; }

.profile-section {
    background: var(--retro-dark);
    border: 2px solid var(--retro-purple);
    border-radius: 10px;
    overflow: hidden;
}

.profile-section-header {
    background: var(--retro-purple);
    padding: 1rem 1.5rem;
    border-bottom: 2px solid var(--retro-cyan);
}

.profile-section-header h3 { margin: 0; color: var(--retro-light); font-size: 1.3rem; }
.profile-section-body { padding: 1.5rem; }

.profile-info-item { display: flex; flex-direction: column; gap: 0.5rem; }
.profile-info-label {
    font-size: 0.85rem;
    color: var(--retro-cyan);
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
.profile-info-value { color: var(--retro-light); font-size: 1rem; }

.profile-bio {
    padding: 1rem;
    background: rgba(103, 97, 168, 0.1);
    border-left: 4px solid var(--retro-cyan);
    border-radius: 5px;
}
.bio-text { color: var(--retro-light); line-height: 1.6; margin: 0; }

.badges-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 1.5rem;
}

.badge-item { text-align: center; position: relative; }

.badge-item-admin { padding-top: 10px; }

.badge-image-wrapper {
    width: 100%;
    aspect-ratio: 1;
    background: linear-gradient(135deg, rgba(103, 97, 168, 0.2), rgba(160, 193, 185, 0.2));
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid var(--retro-purple);
    transition: all 0.3s ease;
    padding: 1rem;
}

.badge-item:hover .badge-image-wrapper {
    transform: scale(1.05);
    border-color: var(--retro-cyan);
    box-shadow: 0 0 20px rgba(160, 193, 185, 0.5);
}

.badge-item-available .badge-image-wrapper {
    opacity: 0.6;
}

.badge-item-available:hover .badge-image-wrapper {
    opacity: 1;
}

.badge-image { max-width: 100%; max-height: 100%; object-fit: contain; }
.badge-name { margin-top: 0.5rem; font-size: 0.85rem; color: var(--retro-light); font-weight: bold; }

.badge-description-hint {
    margin-top: 0.25rem;
    font-size: 0.75rem;
    color: var(--retro-cyan);
    opacity: 0.6;
    cursor: help;
}

.badge-remove-form {
    position: absolute;
    top: 0;
    right: 0;
}

.badge-remove-btn {
    width: 30px;
    height: 30px;
    padding: 0;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.admin-section .profile-section-header.bg-warning {
    background: var(--retro-red) !important;
    color: var(--retro-light) !important;
}

.profile-actions { display: flex; gap: 1rem; flex-wrap: wrap; }
.profile-actions .btn { flex: 1; min-width: 200px; }

@media (max-width: 768px) {
    .profile-header { flex-direction: column; text-align: center; }
    .stat-card { flex-direction: column; text-align: center; }
    .badges-grid { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 1rem; }
    .profile-actions .btn { min-width: 100%; }
}
</style>
{% endblock %}

